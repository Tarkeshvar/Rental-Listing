<% layout("/layouts/boilerplate.ejs") %>

<script>
  const mapKey = "<%= process.env.MAP_KEY %>";
  const listing = <%- JSON.stringify(listing) %>;
</script>

<style>
  /* Main Container */
  .listing-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* Title Section */
  .listing-title {
    font-size: 2rem;
    font-weight: 700;
    color: #222;
    margin-bottom: 0.5rem;
  }

  .listing-subtitle {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
  }

  .listing-subtitle span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .listing-subtitle i {
    color: #fe424d;
  }

  /* Image Gallery */
  .image-gallery {
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .main-image {
    width: 100%;
    height: 500px;
    object-fit: cover;
  }

  /* Content Grid */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 3rem;
    margin-bottom: 3rem;
  }

  /* Left Content */
  .left-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .info-section {
    background: white;
    padding: 2rem;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #222;
    margin-bottom: 1rem;
    padding-bottom: 0.8rem;
    border-bottom: 2px solid #f0f0f0;
  }

  .owner-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #fafafa;
    border-radius: 10px;
    margin-bottom: 1.5rem;
  }

  .owner-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #fe424d;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
  }

  .owner-details h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #222;
  }

  .owner-details p {
    margin: 0;
    font-size: 0.85rem;
    color: #666;
  }

  .description-text {
    color: #444;
    line-height: 1.8;
    font-size: 0.95rem;
  }

  .amenities-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .amenity-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem;
    background: #fafafa;
    border-radius: 8px;
  }

  .amenity-item i {
    color: #fe424d;
    font-size: 1.2rem;
  }

  .amenity-item span {
    font-size: 0.9rem;
    color: #333;
    font-weight: 500;
  }

  /* Right Sidebar - Booking Card */
  .booking-card {
    position: sticky;
    top: 100px;
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    height: fit-content;
  }

  .price-section {
    margin-bottom: 1.5rem;
  }

  .price-amount {
    font-size: 2rem;
    font-weight: 700;
    color: #222;
  }

  .price-label {
    font-size: 0.9rem;
    color: #666;
    font-weight: 400;
  }

  .category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #fff5f6;
    border: 1px solid #fe424d;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #fe424d;
    margin-bottom: 1.5rem;
  }

  .booking-actions {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .btn-primary-custom {
    width: 100%;
    padding: 0.9rem;
    background: #fe424d;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
  }

  .btn-primary-custom:hover {
    background: #e03844;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(254, 66, 77, 0.3);
    color: white;
  }

  .btn-secondary-custom {
    width: 100%;
    padding: 0.8rem;
    background: white;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .btn-secondary-custom:hover {
    border-color: #fe424d;
    color: #fe424d;
    transform: translateY(-2px);
  }

  .delete-form {
    width: 100%;
  }

  .delete-form button {
    width: 100%;
  }

  .location-details {
    padding: 1rem;
    background: #fafafa;
    border-radius: 10px;
    margin-top: 1rem;
  }

  .location-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.8rem;
  }

  .location-item:last-child {
    margin-bottom: 0;
  }

  .location-item i {
    color: #fe424d;
    font-size: 1rem;
  }

  .location-item span {
    color: #444;
    font-size: 0.9rem;
  }

  /* Map Section */
  .map-section {
    background: white;
    padding: 2rem;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 3rem;
  }

  .map-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #222;
    margin-bottom: 1.5rem;
  }

  #map {
    width: 100%;
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
  }

  /* Reviews Section */
  .reviews-section {
    background: white;
    padding: 2rem;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .review-form {
    background: #fafafa;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .review-form h4 {
    color: #fe424d;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 0.8rem;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    border-color: #fe424d;
    box-shadow: 0 0 0 0.2rem rgba(254, 66, 77, 0.15);
  }

  .btn-submit {
    padding: 0.8rem 2rem;
    background: #fe424d;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-submit:hover {
    background: #e03844;
    transform: translateY(-2px);
  }

  .reviews-grid {
    display: grid;
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .review-card {
    background: #fafafa;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
  }

  .review-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: #fe424d;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }

  .review-author {
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #fe424d;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1rem;
  }

  .author-name {
    font-weight: 600;
    color: #222;
    font-size: 0.95rem;
  }

  .review-comment {
    color: #444;
    line-height: 1.6;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  .review-actions {
    display: flex;
    justify-content: flex-end;
  }

  .btn-delete-review {
    padding: 0.5rem 1.2rem;
    background: white;
    color: #666;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-delete-review:hover {
    background: #fee;
    border-color: #dc3545;
    color: #dc3545;
  }

  /* Responsive */
  @media (max-width: 992px) {
    .content-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .booking-card {
      position: relative;
      top: 0;
    }

    .main-image {
      height: 350px;
    }

    .amenities-list {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .listing-title {
      font-size: 1.5rem;
    }

    .main-image {
      height: 280px;
    }

    .info-section {
      padding: 1.5rem;
    }

    .booking-card {
      padding: 1.5rem;
    }

    #map {
      height: 300px;
    }
  }
</style>

<div class="listing-detail-container">
  <!-- Title and Subtitle -->
  <div class="listing-title"><%= listing.title %></div>
  <div class="listing-subtitle">
    <span
      ><i class="fa-solid fa-location-dot"></i> <%= listing.location %>, <%=
      listing.country %></span
    >
    <% if(listing.reviews && listing.reviews.length > 0) { %>
    <span
      ><i class="fa-solid fa-star"></i> <%= (listing.reviews.reduce((sum, r) =>
      sum + r.rating, 0) / listing.reviews.length).toFixed(1) %> (<%=
      listing.reviews.length %> reviews)</span
    >
    <% } %>
  </div>

  <!-- Image Gallery -->
  <div class="image-gallery">
    <img
      src="<%= listing.image.url %>"
      alt="<%= listing.title %>"
      class="main-image"
    />
  </div>

  <!-- Content Grid -->
  <div class="content-grid">
    <!-- Left Content -->
    <div class="left-content">
      <!-- Owner Section -->
      <div class="info-section">
        <div class="owner-info">
          <div class="owner-avatar">
            <%= (listing.owner?.username || "D").charAt(0).toUpperCase() %>
          </div>
          <div class="owner-details">
            <h5>Hosted by <%= listing.owner?.username || "Deleted User" %></h5>
            <p>Superhost</p>
          </div>
        </div>

        <h4 class="section-title">About this place</h4>
        <p class="description-text"><%= listing.description %></p>
      </div>

      <!-- What this place offers -->
      <div class="info-section">
        <h4 class="section-title">What this place offers</h4>
        <div class="amenities-list">
          <div class="amenity-item">
            <i class="fa-solid fa-wifi"></i>
            <span>Free WiFi</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-tv"></i>
            <span>TV</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-kitchen-set"></i>
            <span>Kitchen</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-car"></i>
            <span>Free parking</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-snowflake"></i>
            <span>Air conditioning</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-shirt"></i>
            <span>Washer</span>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="map-section">
        <h4 class="map-title">Where you'll be</h4>
        <div id="map"></div>
      </div>

      <!-- Reviews Section -->
      <div class="reviews-section">
        <% if(currUser) { %>
        <div class="review-form">
          <h4>Leave a Review</h4>
          <form
            action="/listings/<%= listing.id %>/reviews"
            method="post"
            novalidate
            class="needs-validation"
          >
            <div class="mb-3">
              <label for="rating" class="form-label"><b>Rating</b></label>
              <fieldset class="starability-slot">
                <input
                  type="radio"
                  id="no-rate"
                  class="input-no-rate"
                  name="review[rating]"
                  value="1"
                  checked
                  aria-label="No rating."
                />
                <input
                  type="radio"
                  id="first-rate1"
                  name="review[rating]"
                  value="1"
                />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input
                  type="radio"
                  id="first-rate2"
                  name="review[rating]"
                  value="2"
                />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input
                  type="radio"
                  id="first-rate3"
                  name="review[rating]"
                  value="3"
                />
                <label for="first-rate3" title="Average">3 stars</label>
                <input
                  type="radio"
                  id="first-rate4"
                  name="review[rating]"
                  value="4"
                />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input
                  type="radio"
                  id="first-rate5"
                  name="review[rating]"
                  value="5"
                />
                <label for="first-rate5" title="Amazing">5 stars</label>
              </fieldset>
            </div>

            <div class="mb-3">
              <label for="comment" class="form-label"><b>Comments</b></label>
              <textarea
                name="review[comment]"
                id="comment"
                rows="4"
                class="form-control"
                placeholder="Share your experience..."
                required
              ></textarea>
              <div class="invalid-feedback">
                Please add some comments for review
              </div>
            </div>

            <button class="btn btn-submit">Submit Review</button>
          </form>
        </div>
        <% } %> <% if(listing.reviews.length > 0) { %>
        <h4 class="section-title">Reviews (<%= listing.reviews.length %>)</h4>
        <div class="reviews-grid">
          <% for(let review of listing.reviews) { %>
          <div class="review-card">
            <div class="review-header">
              <div class="review-author">
                <div class="author-avatar">
                  <%= (review.author?.username || "D").charAt(0).toUpperCase()
                  %>
                </div>
                <span class="author-name"
                  ><%= review.author?.username || "Deleted User" %></span
                >
              </div>
              <p
                class="starability-result"
                data-rating="<%= review.rating %>"
              ></p>
            </div>
            <p class="review-comment"><%= review.comment %></p>
            <% if (currUser && review.author &&
            currUser._id.equals(review.author._id)) { %>
            <div class="review-actions">
              <form
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                method="POST"
              >
                <button class="btn btn-delete-review">Delete</button>
              </form>
            </div>
            <% } %>
          </div>
          <% } %>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Right Sidebar - Booking Card -->
    <div class="booking-card">
      <div class="price-section">
        <span class="price-amount"
          >â‚¹<%= listing.price.toLocaleString("en-IN") %></span
        >
        <span class="price-label"> / night</span>
      </div>

      <div class="category-badge">
        <% if(listing.category === 'Mountains') { %>
        <i class="fa-solid fa-mountain-sun"></i>
        <% } else if(listing.category === 'Rooms') { %>
        <i class="fa-solid fa-bed"></i>
        <% } else if(listing.category === 'Iconic Cities') { %>
        <i class="fa-solid fa-mountain-city"></i>
        <% } else if(listing.category === 'Castles') { %>
        <i class="fa-solid fa-chess-rook"></i>
        <% } else if(listing.category === 'Amazing Pools') { %>
        <i class="fa-solid fa-person-swimming"></i>
        <% } else if(listing.category === 'Camping') { %>
        <i class="fa-solid fa-tree"></i>
        <% } else if(listing.category === 'Arctic') { %>
        <i class="fa-solid fa-person-snowboarding"></i>
        <% } else { %>
        <i class="fa-solid fa-arrow-trend-up"></i>
        <% } %>
        <span><%= listing.category %></span>
      </div>

      <div class="booking-actions">
        <a href="/listings/<%= listing._id %>/book" class="btn-primary-custom">
          <i class="fa-solid fa-calendar-check"></i> BOOK NOW
        </a>

        <% if (currUser && listing.owner &&
        currUser._id.equals(listing.owner._id)) { %>
        <a
          href="/listings/<%= listing._id %>/edit"
          class="btn-secondary-custom"
        >
          <i class="fa-solid fa-pen"></i> Edit Listing
        </a>
        <form
          action="/listings/<%= listing._id %>?_method=DELETE"
          method="post"
          class="delete-form"
        >
          <button
            class="btn-secondary-custom"
            style="border-color: #dc3545; color: #dc3545"
          >
            <i class="fa-solid fa-trash"></i> Delete Listing
          </button>
        </form>
        <% } %>
      </div>

      <div class="location-details">
        <div class="location-item">
          <i class="fa-solid fa-location-dot"></i>
          <span><%= listing.location %></span>
        </div>
        <div class="location-item">
          <i class="fa-solid fa-globe"></i>
          <span><%= listing.country %></span>
        </div>
      </div>

      <p
        style="
          margin-top: 1.5rem;
          font-size: 0.85rem;
          color: #666;
          text-align: center;
        "
      >
        You won't be charged yet
      </p>
    </div>
  </div>
</div>

<script src="/js/map.js"></script>
